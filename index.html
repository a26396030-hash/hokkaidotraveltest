<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æµ·é“äº”å¤©å››å¤œãƒ»æ—…éŠå°ç¨‹å¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ï¼Œè®“å®ƒåœ¨ Tailwind é è¨­å¤–è§€ä¸Šæ›´ç¾è§€ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #a1c4fd; /* primary blue light */
            border-radius: 20px;
            border: 2px solid transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f7f7f7;
        }

        /* ç¢ºä¿ Vue App å…§å®¹å¡«æ»¿å®¹å™¨ */
        #app {
            min-height: 100vh;
            padding-bottom: 50px;
            background: linear-gradient(to bottom, #a1c4fd 0%, #c2e9fb 100%);
        }

        /* æµ®å‹•å¤©æ°£æŒ‰éˆ•çš„å‹•ç•« */
        .weather-float-btn {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .weather-float-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* Modal é®ç½©å±¤ */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Modal å…§å®¹å‹•ç•« */
        .modal-enter-active, .modal-leave-active {
            transition: opacity 0.3s ease;
        }
        .modal-enter-from, .modal-leave-to {
            opacity: 0;
        }
    </style>
</head>
<body>

<div id="app" class="font-sans">
    <div class="container mx-auto p-4 max-w-4xl">
        
        <header class="text-center bg-white p-6 rounded-3xl shadow-xl mb-6 border-4 border-white transform hover:scale-[1.01] transition duration-300">
            <h1 class="text-3xl font-bold text-blue-700 mb-1">â„ï¸ åŒ—æµ·é“äº”å¤©å››å¤œãƒ»æ—…éŠå°ç¨‹å¼ â„ï¸</h1>
            <p class="text-sm text-gray-500">é›ªåœ‹æ¢éšªä¹‹æ—… ğŸ§</p>
        </header>

        <div class="flex justify-center flex-wrap gap-2 mb-6">
            <button v-for="tab in tabs" :key="tab.id"
                    @click="currentTab = tab.id"
                    :class="[
                        'tab-btn',
                        'px-4 py-2 rounded-full font-semibold transition duration-200 shadow-md',
                        currentTab === tab.id
                            ? tab.activeClass
                            : tab.inactiveClass
                    ]">
                {{ tab.name }}
            </button>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-2xl relative custom-scrollbar overflow-y-auto max-h-[80vh]">

            <div v-if="currentTab.startsWith('day')" class="min-h-[400px] relative">
                
                <h2 class="text-2xl font-bold text-blue-800 border-b-2 border-blue-200 pb-3 mb-4 flex items-center">
                    {{ dayName }} è¡Œç¨‹è¡¨ <span class="text-lg ml-3 text-blue-500">ï¼ˆé»æ“Šç·¨è¼¯æŒ‰éˆ•å³å¯ä¿®æ”¹ï¼‰</span>
                </h2>

                <div class="space-y-4">
                    <div v-for="(item, index) in currentItinerary" :key="item.id"
                         class="timeline-item bg-gray-50 p-4 rounded-lg shadow-sm border-l-4 border-blue-400 relative group transition duration-150 ease-in-out hover:shadow-md">
                        
                        <div v-if="item.editing" class="flex flex-col space-y-2">
                            <input type="text" v-model="item.time" placeholder="æ™‚é–“ (ä¾‹å¦‚: 08:00)"
                                   class="p-2 border border-blue-300 rounded focus:ring-blue-500 focus:border-blue-500 text-base font-semibold"/>
                            <textarea v-model="item.activity" placeholder="åœ°é»/æ´»å‹•è©³æƒ…"
                                      class="p-2 border border-blue-300 rounded focus:ring-blue-500 focus:border-blue-500 text-base h-20"></textarea>
                            <div class="flex justify-end space-x-2 mt-2">
                                <button @click="saveItem(item)" class="px-3 py-1 bg-green-500 text-white rounded text-sm hover:bg-green-600 transition">å„²å­˜</button>
                                <button @click="cancelEdit(item, index)" class="px-3 py-1 bg-gray-400 text-white rounded text-sm hover:bg-gray-500 transition">å–æ¶ˆ</button>
                            </div>
                        </div>

                        <div v-else>
                            <div class="font-bold text-lg text-blue-600">{{ item.time }}</div>
                            <div class="text-gray-800 ml-1 mb-3">{{ item.activity }}</div>
                            
                            <div class="flex flex-wrap space-x-2 space-y-2 sm:space-y-0 mt-2">
                                <button @click.stop="openLink(generateGoogleMapsUrl(item.activity))"
                                        class="flex items-center text-sm px-3 py-1 bg-green-500 text-white rounded-full hover:bg-green-600 transition shadow-md">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V14a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" transform="rotate(180 10 10)"/></svg>
                                    åœ°åœ–
                                </button>
                                <button @click.stop="openNotesModal(item)"
                                        class="flex items-center text-sm px-3 py-1 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition shadow-md relative">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M17 11V9h-3V5h-2v4h-3V5H7v4H4v2h3v4h2v-4h3v4h2v-4h3zM10 3a1 1 0 00-1 1v1h2V4a1 1 0 00-1-1zM5 15a1 1 0 100 2h10a1 1 0 100-2H5z"/></svg>
                                    æ™¯é»å‚™è¨»
                                    <span v-if="item.notes && item.notes.trim()" class="absolute -top-1 -right-1 block h-2 w-2 rounded-full ring-2 ring-white bg-red-500"></span>
                                </button>
                                <button @click.stop="editItem(item)"
                                        class="flex items-center text-sm px-3 py-1 bg-gray-300 text-gray-700 rounded-full hover:bg-gray-400 transition shadow-md">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-8.28 8.28a2 2 0 01-1.414 1.414L4 14.586V16h1.414l2.293-2.293a2 2 0 011.414-1.414l.793-.793-2.828-2.828-.793.793zM12 15a1 1 0 100 2h3a1 1 0 100-2h-3z"/></svg>
                                    ç·¨è¼¯
                                </button>
                            </div>
                            <div v-if="item.notes && item.notes.trim()" class="mt-2 text-sm text-red-600 border-l-2 border-red-400 pl-2">
                                ğŸ“Œ å‚™è¨»ï¼š{{ item.notes }}
                            </div>
                        </div>

                        <button @click="deleteItem(item.id)"
                                class="absolute right-2 top-2 p-1 text-red-500 opacity-0 group-hover:opacity-100 transition duration-300 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                    
                    <div v-if="currentItinerary.length === 0" class="text-center text-gray-400 py-10">
                        ä»Šæ—¥è¡Œç¨‹å°šæœªè¦åŠƒï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•æ–°å¢ç¬¬ä¸€å€‹é …ç›®ã€‚
                    </div>
                </div>
                
                <button @click="openAddItem"
                        class="mt-6 w-full py-3 bg-blue-500 text-white rounded-lg font-bold shadow-lg hover:bg-blue-600 transition duration-200 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                    æ–°å¢è¡Œç¨‹é …ç›®
                </button>
            </div>

            <div v-else-if="currentTab === 'accounting'" class="min-h-[400px]">
                <h2 class="text-2xl font-bold text-green-700 border-b-2 border-green-200 pb-3 mb-4">
                    è¨˜å¸³ç³»çµ± <span class="text-lg text-green-500"> (åŒ¯ç‡: 1 JPY â‰ˆ {{ exchangeRateTWD.toFixed(4) }} TWD)</span>
                </h2>

                <div class="grid grid-cols-2 gap-4 mb-6 text-center">
                    <div class="bg-blue-50 p-4 rounded-xl shadow-inner border border-blue-200">
                        <p class="text-lg font-medium text-gray-600">ç¸½èŠ±è²» (æ—¥å¹£)</p>
                        <p class="text-3xl font-extrabold text-blue-600 mt-1">{{ totalJPY.toLocaleString() }} Â¥</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-xl shadow-inner border border-green-200">
                        <p class="text-lg font-medium text-gray-600">ç¸½èŠ±è²» (å°å¹£)</p>
                        <p class="text-3xl font-extrabold text-green-600 mt-1">{{ totalTWD.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) }} $</p>
                    </div>
                </div>

                <div class="bg-gray-100 p-4 rounded-lg mb-6 shadow">
                    <h3 class="font-bold text-gray-700 mb-3">æ–°å¢äº¤æ˜“</h3>
                    <div class="flex space-x-3">
                        <input type="text" v-model="newTransaction.description" placeholder="é …ç›®æè¿° (ä¾‹å¦‚: æ™šé¤)"
                               class="p-2 border border-gray-300 rounded flex-1 focus:ring-indigo-500" />
                        <input type="number" v-model.number="newTransaction.amountJPY" placeholder="é‡‘é¡ (JPY)"
                               class="p-2 border border-gray-300 rounded w-24 focus:ring-indigo-500" />
                        <select v-model="newTransaction.category"
                                class="p-2 border border-gray-300 rounded w-32 focus:ring-indigo-500">
                            <option value="">é¸æ“‡é¡åˆ¥</option>
                            <option value="Food">é¤é£² ğŸœ</option>
                            <option value="Shopping">è³¼ç‰© ğŸ›ï¸</option>
                            <option value="Transport">äº¤é€š ğŸšŒ</option>
                            <option value="Hotel">ä½å®¿ ğŸ¨</option>
                            <option value="Other">å…¶ä»– ğŸ’¡</option>
                        </select>
                        <button @click="addTransaction"
                                class="px-4 py-2 bg-indigo-500 text-white rounded font-semibold hover:bg-indigo-600 transition">
                            æ–°å¢
                        </button>
                    </div>
                    <p v-if="newTransaction.amountJPY > 0" class="text-xs text-right text-gray-500 mt-1">
                        ç´„ {{ (newTransaction.amountJPY * exchangeRateTWD).toFixed(0) }} TWD
                    </p>
                </div>

                <div class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar">
                    <div v-for="tx in sortedAccountingData" :key="tx.id"
                         class="flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-150">
                        <div>
                            <span :class="['text-xs font-semibold px-2 py-1 rounded-full mr-2', getCategoryColor(tx.category)]">{{ getCategoryEmoji(tx.category) }}</span>
                            <span class="font-medium text-gray-800">{{ tx.description }}</span>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-red-500">{{ tx.amountJPY.toLocaleString() }} Â¥</p>
                            <p class="text-xs text-gray-500"> â‰ˆ {{ tx.amountTWD.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) }} $</p>
                        </div>
                        <button @click="deleteTransaction(tx.id)" class="text-gray-400 hover:text-red-500 transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div v-else-if="currentTab === 'packing'" class="min-h-[400px]">
                <h2 class="text-2xl font-bold text-purple-700 border-b-2 border-purple-200 pb-3 mb-4">
                    å¿…å¸¶ç‰©å“æ¸…å–® ğŸ’
                </h2>

                <div class="bg-gray-100 p-4 rounded-lg mb-6 shadow">
                    <h3 class="font-bold text-gray-700 mb-3">æ–°å¢ç‰©å“</h3>
                    <div class="flex space-x-2">
                        <input type="text" v-model="newItemName" placeholder="æ–°å¢ç‰©å“åç¨±..."
                               @keyup.enter="addPackingItem"
                               class="p-2 border border-gray-300 rounded flex-1 focus:ring-purple-500" />
                        <select v-model="newCategory"
                                class="p-2 border border-gray-300 rounded w-32 focus:ring-purple-500">
                            <option value="carryon">æ‰‹æ/éš¨èº«</option>
                            <option value="checked">æ‰˜é‹è¡Œæ</option>
                        </select>
                        <button @click="addPackingItem"
                                class="px-4 py-2 bg-purple-500 text-white rounded font-semibold hover:bg-purple-600 transition">
                            æ–°å¢
                        </button>
                    </div>
                </div>

                <div class="mt-4 text-sm text-gray-600 mb-6 flex justify-between">
                    <p>å·²æ‰“åŒ…: <span class="font-bold text-green-600">{{ packedCount }}</span> / ç¸½é …ç›®: <span class="font-bold">{{ packingList.length }}</span></p>
                    <button @click="resetPackingList" class="text-red-400 hover:text-red-600 transition">é‡è¨­æ‰€æœ‰ç‹€æ…‹</button>
                </div>
                
                <div class="space-y-6 max-h-[50vh] overflow-y-auto custom-scrollbar">

                    <div class="border border-purple-300 rounded-xl p-4 bg-purple-50 shadow-inner">
                        <h3 class="text-xl font-bold text-purple-700 mb-2 flex items-center">
                            âœˆï¸ éš¨èº«/æ‰‹æè¡Œæ ({{ carryonCount }})
                        </h3>
                        <p class="text-sm text-red-500 font-semibold mb-3 border-b border-purple-200 pb-2">
                            ğŸš¨ å‚™è¨»ï¼šæ¯äººä¸Šé™ 10 å…¬æ–¤
                        </p>
                        <div class="space-y-2">
                            <div v-for="item in filteredPackingList('carryon')" :key="item.id"
                                 class="flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-150">
                                <div class="flex items-center flex-1 cursor-pointer" @click="togglePackingItem(item.id)">
                                    <input type="checkbox" :checked="item.packed"
                                           class="form-checkbox h-5 w-5 text-purple-600 rounded-sm mr-3 focus:ring-purple-500"
                                           @change.stop="togglePackingItem(item.id)">
                                    <span :class="{'line-through text-gray-400': item.packed, 'text-gray-800 font-medium': !item.packed}">
                                        {{ item.name }}
                                    </span>
                                </div>
                                <button @click="deletePackingItem(item.id)" class="text-gray-400 hover:text-red-500 transition p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                            <div v-if="filteredPackingList('carryon').length === 0" class="text-center text-gray-400 py-3">
                                éš¨èº«è¡Œææ¸…å–®ç‚ºç©ºã€‚
                            </div>
                        </div>
                    </div>

                    <div class="border border-blue-300 rounded-xl p-4 bg-blue-50 shadow-inner">
                        <h3 class="text-xl font-bold text-blue-700 mb-2 flex items-center">
                            ğŸ§³ æ‰˜é‹è¡Œæ ({{ checkedCount }})
                        </h3>
                         <p class="text-sm text-red-500 font-semibold mb-3 border-b border-blue-200 pb-2">
                            ğŸš¨ å‚™è¨»ï¼šæ¯äººä¸Šé™ 25 å…¬æ–¤
                        </p>
                        <div class="space-y-2">
                            <div v-for="item in filteredPackingList('checked')" :key="item.id"
                                 class="flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition duration-150">
                                <div class="flex items-center flex-1 cursor-pointer" @click="togglePackingItem(item.id)">
                                    <input type="checkbox" :checked="item.packed"
                                           class="form-checkbox h-5 w-5 text-blue-600 rounded-sm mr-3 focus:ring-blue-500"
                                           @change.stop="togglePackingItem(item.id)">
                                    <span :class="{'line-through text-gray-400': item.packed, 'text-gray-800 font-medium': !item.packed}">
                                        {{ item.name }}
                                    </span>
                                </div>
                                <button @click="deletePackingItem(item.id)" class="text-gray-400 hover:text-red-500 transition p-1">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                             <div v-if="filteredPackingList('checked').length === 0" class="text-center text-gray-400 py-3">
                                æ‰˜é‹è¡Œææ¸…å–®ç‚ºç©ºã€‚
                            </div>
                        </div>
                    </div>
                </div>


            </div>

            <div v-else-if="currentTab === 'flight'" class="min-h-[400px]">
                <h2 class="text-2xl font-bold text-red-700 border-b-2 border-red-200 pb-3 mb-4 flex items-center">
                    âœˆï¸ èˆªç­è³‡è¨Šè©³æƒ…
                </h2>
                
                <div class="space-y-6">
                    <div class="p-4 bg-red-50 rounded-xl border-l-4 border-red-400 shadow-md">
                        <p class="font-bold text-xl text-red-600 mb-2">ğŸ›« 12æœˆ6æ—¥ (é€±å…­) - å»ç¨‹</p>
                        <ul class="text-gray-700 space-y-1 text-base ml-4 list-disc">
                            <li><span class="font-semibold">èˆªç©ºå…¬å¸/ç­è™Ÿ:</span> å°ç£è™èˆª IT238</li>
                            <li><span class="font-semibold">èµ·é£›åœ°:</span> æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)</li>
                            <li><span class="font-semibold">ç›®çš„åœ°:</span> æ—­å·æ©Ÿå ´ (AKJ)</li>
                            <li><span class="font-semibold">é è¨ˆèµ·é£›/æŠµé”:</span> 09:30 / 14:30</li>
                            <li><span class="font-semibold text-blue-500">å‚™è¨»:</span> æŠµé”æ—­å·å¾Œéœ€å‰å¾€æ´çˆºæ¹–ï¼Œè«‹é ç•™å……è¶³è½‰è»Šæ™‚é–“ã€‚</li>
                        </ul>
                    </div>

                    <div class="p-4 bg-blue-50 rounded-xl border-l-4 border-blue-400 shadow-md">
                        <p class="font-bold text-xl text-blue-600 mb-2">ğŸ›¬ 12æœˆ10æ—¥ (é€±ä¸‰) - å›ç¨‹</p>
                        <ul class="text-gray-700 space-y-1 text-base ml-4 list-disc">
                            <li><span class="font-semibold">èˆªç©ºå…¬å¸/ç­è™Ÿ:</span> å°ç£è™èˆª IT239</li>
                            <li><span class="font-semibold">èµ·é£›åœ°:</span> å‡½é¤¨æ©Ÿå ´ (HKD)</li>
                            <li><span class="font-semibold">ç›®çš„åœ°:</span> æ¡ƒåœ’åœ‹éš›æ©Ÿå ´ (TPE)</li>
                            <li><span class="font-semibold">é è¨ˆèµ·é£›/æŠµé”:</span> 15:30 / 19:30</li>
                            <li><span class="font-semibold text-red-500">å‚™è¨»:</span> éœ€æå‰å¾å¸‚å€å‰å¾€å‡½é¤¨æ©Ÿå ´ï¼Œæ³¨æ„é€€æˆ¿æ™‚é–“ã€‚</li>
                        </ul>
                    </div>
                </div>

                <div class="text-center text-gray-400 py-10">
                    <p>æ‰€æœ‰æ™‚é–“è«‹ä»¥æœ€çµ‚èˆªç©ºå…¬å¸é€šçŸ¥ç‚ºæº–ã€‚</p>
                </div>
            </div>
            
        </div>
    </div>
    
    <div v-if="weatherDisplay && currentTab.startsWith('day')"
         class="fixed bottom-4 right-4 z-50">
        
        <div @click="toggleWeatherDetail"
             class="weather-float-btn bg-yellow-400 text-white w-16 h-16 rounded-full flex flex-col items-center justify-center text-xs shadow-lg ring-4 ring-white">
            <span class="text-2xl">{{ weatherDisplay.icon }}</span>
            <span class="font-bold">{{ weatherDisplay.temp }}Â°C</span>
        </div>
        
        <div v-if="showWeatherDetail"
             class="absolute right-0 bottom-20 z-20 p-4 bg-white rounded-xl shadow-xl border-2 border-blue-400 w-48 transition-all duration-300 transform origin-bottom-right">
            <p class="font-bold text-blue-700">{{ weatherDisplay.location }}</p>
            <p class="text-4xl my-1">{{ weatherDisplay.icon }}</p>
            <p class="text-3xl font-extrabold text-gray-800">{{ weatherDisplay.temp }}Â°C</p>
            <p class="text-sm text-gray-500">{{ weatherDisplay.desc }}</p>
            <button @click="showWeatherDetail = false" class="text-xs text-red-500 mt-2">é—œé–‰</button>
        </div>
        
    </div>
    <transition name="modal">
        <div v-if="showNotesModal" class="modal-overlay" @click.self="closeNotesModal">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg mx-auto transform transition-all duration-300 scale-100" @click.stop>
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold text-indigo-700">ğŸ“ {{ selectedItem.activity }}</h3>
                    <button @click="closeNotesModal" class="text-gray-400 hover:text-gray-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <div class="bg-indigo-50 p-4 rounded-lg mb-4 border-l-4 border-indigo-400">
                    <p class="font-semibold text-indigo-800 mb-2">æ™¯é»ä»‹ç´¹ï¼š</p>
                    <p class="text-sm text-gray-700">{{ selectedItem.description || 'ç›®å‰æ²’æœ‰æ­¤æ™¯é»çš„é è¨­ä»‹ç´¹ã€‚' }}</p>
                </div>

                <div class="mb-4">
                    <label for="item-notes" class="block text-sm font-medium text-gray-700 mb-2">æ‚¨çš„å€‹äººå‚™è¨»ï¼š</label>
                    <textarea id="item-notes" v-model="selectedItem.notes"
                              class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 h-32"
                              placeholder="ä¾‹å¦‚ï¼šè¨˜å¾—å¸¶ç›¸æ©Ÿè…³æ¶ã€æ‰¾å°‹æ¨è–¦çš„XXæµ·é®®é¤å»³..."></textarea>
                </div>

                <div class="flex justify-end space-x-3">
                    <button @click="closeNotesModal"
                            class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg font-semibold hover:bg-gray-400 transition">
                        é—œé–‰
                    </button>
                    <button @click="closeNotesModal"
                            class="px-4 py-2 bg-indigo-500 text-white rounded-lg font-semibold hover:bg-indigo-600 transition">
                        å„²å­˜ (å·²è‡ªå‹•å„²å­˜)
                    </button>
                </div>

            </div>
        </div>
    </transition>
    </div>

<script type="module">
    const { createApp, ref, reactive, computed, watch, onMounted } = Vue;

    const APP_KEY = 'hokkaido_trip_v3';
    
    // --- å¤©æ°£ç›¸é—œè¨­å®š ---
    const weatherLocations = {
        'day1': { location: 'æ´çˆºæ¹–', lat: 42.55, lon: 140.83, desc: 'æ¹–ç•”æº«æ³‰å€' },
        'day2': { location: 'æœ­å¹Œ', lat: 43.06, lon: 141.35, desc: 'åŸå¸‚å¸‚å€/ç‹¸å°è·¯' }, 
        'day3': { location: 'ç™»åˆ¥', lat: 42.49, lon: 141.13, desc: 'æº«æ³‰æ¸¡å‡æ‘/æµ·æ´‹å…¬åœ’' },
        'day4': { location: 'å‡½é¤¨', lat: 41.77, lon: 140.73, desc: 'å‡½é¤¨å¤œæ™¯å€' },
        'day5': { location: 'å‡½é¤¨', lat: 41.77, lon: 140.73, desc: 'å…ƒæ°£æœå¸‚/æ©Ÿå ´' } 
    };

    function getWeatherIcon(code) {
        if (code <= 1) return "â˜€ï¸"; 
        if (code <= 3) return "â˜ï¸"; 
        if (code <= 48) return "ğŸŒ«ï¸"; 
        if (code <= 67) return "ğŸŒ§ï¸"; 
        if (code <= 77) return "â„ï¸"; 
        if (code <= 82) return "ğŸŒ¨ï¸"; 
        if (code <= 86) return "ğŸŒ¨ï¸"; 
        if (code <= 99) return "â›ˆï¸"; 
        return "â„ï¸"; 
    }
    
    // --- é€£çµç”¢ç”Ÿ Helper Functions ---
    const generateGoogleMapsUrl = (activity) => {
        // ä½¿ç”¨ "åŒ—æµ·é“" + æ´»å‹•åç¨± é€²è¡Œåœ°åœ–æŸ¥è©¢
        const query = encodeURIComponent(`åŒ—æµ·é“ ${activity}`);
        return `https://www.google.com/maps/search/${query}`;
    };

    const openLink = (url) => {
        window.open(url, '_blank');
    };
    
    // --- é è¨­æ™¯é»ä»‹ç´¹è³‡æ–™ ---
    const defaultDescriptions = {
        'æ¡ƒåœ’æ©Ÿå ´ âœˆï¸ æ—­å·æ©Ÿå ´ (åˆé¤æ©Ÿä¸Šæˆ–æ©Ÿå ´)': 'å¾å°ç£æ¡ƒåœ’åœ‹éš›æ©Ÿå ´å‡ºç™¼ï¼Œæ­ä¹˜ç­æ©Ÿé£›å¾€åŒ—æµ·é“æ—­å·æ©Ÿå ´ã€‚åˆé¤é€šå¸¸åœ¨æ©Ÿä¸Šæˆ–æŠµé”æ©Ÿå ´å¾Œè‡ªè¡Œè§£æ±ºã€‚',
        'æ—­å·æ©Ÿå ´æ­è»Š/ç§Ÿè»Šå‰å¾€æ´çˆºæ¹–': 'æŠµé”æ—­å·å¾Œï¼Œå°‡æ­ä¹˜äº¤é€šå·¥å…·å‰å¾€æ´çˆºæ¹–æº«æ³‰å€ã€‚è·¯ç¨‹è¼ƒé•·ï¼Œå»ºè­°æå‰å®‰æ’å¥½äº¤é€šæ–¹å¼ã€‚',
        'å¤œå®¿ æ´çˆº æ¹–ç•”äº­ (æ™šé¤: æº«æ³‰æ—…é¤¨)': 'å…¥ä½ä½æ–¼æ´çˆºæ¹–ç•”çš„æº«æ³‰æ—…é¤¨ï¼Œäº«å—æ—¥å¼æ™šé¤å’Œæº«æ³‰è¨­æ–½ã€‚æ¹–ç•”çš„æ™¯è‰²å®œäººï¼Œéå¸¸é©åˆæ”¾é¬†èº«å¿ƒã€‚',
        'æ´çˆºæ¹–å†¬å­£å½©ç‡ˆç¯€ â„ï¸': 'æ¯å¹´å†¬å­£èˆ‰è¾¦çš„å½©ç‡ˆéš§é“ï¼Œå°‡æº«æ³‰è¡—é»ç¶´å¾—æµªæ¼«è¿·äººã€‚é€™æ˜¯å¤œæ™šæ´»å‹•çš„äº®é»ï¼Œéå¸¸é©åˆé£¯å¾Œæ•£æ­¥æ‹ç…§ã€‚',
        'æ´çˆºæ¹–å‡ºç™¼ï¼Œå‰å¾€å°æ¨½': 'äº«ç”¨æ—©é¤å¾Œï¼Œå¾æ´çˆºæ¹–å‡ºç™¼ï¼Œå‰å¾€å……æ»¿æ­æ´²é¢¨æƒ…çš„æ¸¯å£åŸå¸‚å°æ¨½ã€‚æ²¿é€”å¯æ¬£è³åŒ—æµ·é“çš„å†¬å­£é¢¨å…‰ã€‚',
        'å°æ¨½é‹æ²³ã€éŸ³æ¨‚ç›’å ‚ã€åŒ—ä¸€ç¡å­é¤¨': 'å°æ¨½é‹æ²³æ˜¯åŸå¸‚æœ€å…·ä»£è¡¨æ€§çš„åœ°æ¨™ï¼Œæ²¿å²¸çš„çŸ³é€ å€‰åº«å……æ»¿æ‡·èˆŠæ°£æ¯ã€‚é™„è¿‘éä½ˆç»ç’ƒå·¥è—å’ŒéŸ³æ¨‚ç›’å•†åº—ï¼Œæ˜¯è³¼è²·ä¼´æ‰‹ç¦®çš„å¥½å»è™•ã€‚',
        'åˆé¤å¾Œï¼ŒAEON MALL (æœ­å¹Œå°æ¨½æ²¿ç·š) è³¼ç‰©/ä¼‘æ¯': 'AEON MALLæ˜¯æ—¥æœ¬çš„å¤§å‹è³¼ç‰©ä¸­å¿ƒï¼Œæä¾›å„å¼æœé£¾ã€æ—¥ç”¨å“èˆ‡ç¾é£Ÿå»£å ´ï¼Œæ˜¯è¼•é¬†è³¼ç‰©å’Œè£œçµ¦çš„å¥½åœ°æ–¹ã€‚',
        'å¤œå®¿ å®œå¿…æ€å°šå“æœ­å¹Œé…’åº—': 'æŠµé”æœ­å¹Œå¸‚å€å¾Œï¼Œå…¥ä½é…’åº—ã€‚é…’åº—ä½ç½®æ–¹ä¾¿ï¼Œé„°è¿‘å¸‚ä¸­å¿ƒä¸»è¦æ™¯é»å’Œäº¤é€šæ¨ç´ã€‚',
        'æ™šé¤å¾Œï¼Œå¤œè¨ªè²å°è·¯ å•†åº—è¡— (è³¼ç‰©/å®µå¤œ)': 'è²å°è·¯æ˜¯æœ­å¹Œæ­·å²æœ€æ‚ ä¹…ã€è¦æ¨¡æœ€å¤§çš„å•†åº—è¡—ä¹‹ä¸€ï¼Œæ©«è·¨å¤šå€‹è¡—å€ï¼Œç„¡è«–æ˜¯è—¥å¦ã€ç´€å¿µå“æˆ–ç‰¹è‰²é¤å»³éƒ½ä¸€æ‡‰ä¿±å…¨ã€‚',
        'æ™‚è¨ˆå°ã€åŒ—æµ·é“å»³èˆŠæœ¬å»³èˆ (è»Šç¶“/æ‹ç…§)': 'è»Šç¶“æœ­å¹Œçš„ç¶“å…¸åœ°æ¨™ï¼šæ™‚è¨ˆå°å’Œç´…ç£šå»ºé€ çš„åŒ—æµ·é“å»³èˆŠæœ¬å»³èˆï¼Œéƒ½æ˜¯æ‹ç…§ç•™å¿µçš„å¥½åœ°æ–¹ã€‚',
        'åŒ—æµ·é“ç¥å®® (åƒæ‹œ)': 'åŒ—æµ·é“ç¥å®®æ˜¯åŒ—æµ·é“æœ€é‡è¦ä¸”è¦æ¨¡æœ€å¤§çš„ç¥ç¤¾ï¼Œä¾›å¥‰è‘—é–‹æ‹“ä¹‹ç¥ï¼Œå¸¸æœ‰ç•¶åœ°å±…æ°‘åŠéŠå®¢å‰ä¾†ç¥ˆæ±‚é–‹æ‹“ç™¼å±•èˆ‡è‰¯ç·£ã€‚',
        'åˆé¤åŠå…ç¨…å•†åº— (æœ­å¹Œå¸‚å€)': 'æ­¤è™•é€šå¸¸ç‚ºåœ˜é«”éŠå®¢å®‰æ’çš„è³¼ç‰©é»ï¼Œæ–¹ä¾¿è³¼è²·ä¿å¥é£Ÿå“ã€é›»å­ç”¢å“ç­‰ï¼Œè¨˜å¾—æª¢æŸ¥åƒ¹æ ¼èˆ‡éœ€æ±‚ã€‚',
        'é–‹è»Šå‰å¾€å°¼å…‹æ–¯æµ·æ´‹å…¬åœ’ (ç™»åˆ¥)': 'é©…è»Šå‰å¾€ç™»åˆ¥ï¼Œå°¼å…‹æ–¯æµ·æ´‹å…¬åœ’æ˜¯ä¸€åº§ä»¥ä¸¹éº¥ä¸­ä¸–ç´€åŸå ¡ç‚ºä¸»é¡Œçš„æµ·æ´‹æ¨‚åœ’ã€‚',
        'å°¼å…‹æ–¯æµ·æ´‹å…¬åœ’ ğŸ¬ (ä¼éµéŠè¡Œç­‰)': 'åœ’å…§æœ€å—æ­¡è¿çš„æ´»å‹•æ˜¯å¯æ„›çš„ä¼éµéŠè¡Œï¼Œå®ƒå€‘æ–æ–æ“ºæ“ºåœ°åœ¨æ­¥é“ä¸Šè¡Œèµ°ï¼Œé‚„æœ‰å£¯è§€çš„ã€Œæ°´æ™¶å¡”ã€æ°´æ—é¤¨ã€‚',
        'å¤œå®¿ æ£®ä¹‹åº­æ¸¡å‡æ‘ (æ™šé¤: æº«æ³‰æ¸¡å‡æ‘)': 'å…¥ä½ç™»åˆ¥çš„æº«æ³‰æ¸¡å‡æ‘ï¼Œäº«å—å„ªè³ªçš„æº«æ³‰æµ´å’Œè±ç››çš„è‡ªåŠ©æ™šé¤ï¼Œæ˜¯ç·©è§£æ—…é€”ç–²å‹çš„çµ•ä½³é¸æ“‡ã€‚',
        'æ˜­å’Œæ–°å±±ã€ç†Šç‰§å ´ (èˆ‡æ£•ç†Šäº’å‹•)': 'æ˜­å’Œæ–°å±±æ˜¯æ–¼æ˜­å’Œå¹´é–“ç¶“ç”±ç«å±±å™´ç™¼éš†èµ·çš„æ´»ç«å±±ï¼Œå±±è…³ä¸‹çš„ç†Šç‰§å ´å¯ä»¥è¿‘è·é›¢è§€å¯ŸåŒ—æµ·é“ç‰¹æœ‰çš„æ£•ç†Šã€‚',
        'é–‹è»Šå‰å¾€å‡½é¤¨': 'å¾ç™»åˆ¥å‡ºç™¼ï¼Œæ²¿è‘—æµ·å²¸ç·šæˆ–é«˜é€Ÿå…¬è·¯é©…è»Šå‰å¾€åŒ—æµ·é“å—éƒ¨çš„å‡½é¤¨å¸‚ã€‚',
        'å¤§ã€å°æ²¼åœ‹ç«‹å…¬åœ’ (æ¹–ç•”æ™¯è§€)': 'ä½æ–¼å‡½é¤¨é™„è¿‘ï¼Œä»¥é§’å²³å±±ç‚ºèƒŒæ™¯ï¼Œæ¹–ä¸­æ•£ä½ˆè‘—å°å³¶ï¼Œå†¬å­£çµå†°å¾Œæ™¯è‰²å„ªç¾ï¼Œæä¾›é›ªåœ°æ´»å‹•æˆ–æ¬£è³å†°æ¹–ç¾æ™¯ã€‚',
        'é‡‘æ£®å€‰åº«ç¾¤ (æµ·ç£å€è³¼ç‰©)': 'å‡½é¤¨æµ·ç£é‚Šçš„ç´…ç£šå€‰åº«ç¾¤ï¼Œç¾åœ¨å·²æ”¹å»ºç‚ºç¶œåˆå•†å ´ï¼Œå……æ»¿ç•°åœ‹é¢¨æƒ…ï¼Œæ˜¯å‡½é¤¨æœ€å—æ­¡è¿çš„è³¼ç‰©å’Œç¾é£Ÿå€åŸŸã€‚',
        'å…¥ä½ æ¹¯å…ƒ å•„æœ¨äº­': 'åœ¨å‡½é¤¨å…¥ä½é…’åº—ï¼Œæ”¾ä¸‹è¡Œæå¾Œå¯æº–å‚™æ™šä¸Šçš„è¡Œç¨‹ã€‚é€™å®¶é…’åº—å¯èƒ½æä¾›ä¸éŒ¯çš„æº«æ³‰è¨­æ–½ã€‚',
        'å‡½é¤¨å±± ç™¾è¬å¤œæ™¯ ğŸŒƒ': 'è¢«è­½ç‚ºä¸–ç•Œä¸‰å¤§å¤œæ™¯ä¹‹ä¸€ï¼Œå¾å‡½é¤¨å±±é ‚ä¿¯ç°ï¼ŒåŸå¸‚å…©å´æµ·ç£çš„æ›²ç·šå½¢æˆç¨ç‰¹çš„ã€Œæ²™æ¼ã€æˆ–ã€Œè‘«è˜†ã€å½¢ç‹€ï¼Œæ¥µç‚ºå£¯è§€ã€‚',
        'å…ƒæ°£æœå¸‚ (æµ·é®®æœå¸‚ï¼Œäº«ç”¨æµ·é®®ä¸¼)': 'å‡½é¤¨çš„è‘—åæµ·é®®å¸‚å ´ï¼Œæä¾›æœ€æ–°é®®çš„æµ·ç”¢ï¼Œå¯ä»¥åœ¨é€™è£¡äº«ç”¨è±ç››çš„æ—©é¤æµ·é®®ä¸¼ï¼Œæˆ–é«”é©—é‡£çƒè³Šçš„æ¨‚è¶£ã€‚',
        'é€€æˆ¿ï¼Œå‰å¾€å‡½é¤¨æ©Ÿå ´': 'åœ¨è¦å®šçš„æ™‚é–“å…§å¾é…’åº—é€€æˆ¿ï¼Œä¸¦å‰å¾€å‡½é¤¨æ©Ÿå ´æº–å‚™æ­ä¹˜å›ç¨‹ç­æ©Ÿã€‚',
        'å‡½é¤¨æ©Ÿå ´ âœˆï¸ æ¡ƒåœ’æ©Ÿå ´ (è³¦æ­¸)': 'æ­ä¹˜ç­æ©Ÿå¾å‡½é¤¨æ©Ÿå ´è¿”å›å°ç£æ¡ƒåœ’æ©Ÿå ´ï¼ŒçµæŸæ„‰å¿«çš„åŒ—æµ·é“äº”å¤©å››å¤œä¹‹æ—…ã€‚',
        'ç„¡ç°¡çŸ­ä»‹ç´¹': 'æ­¤é …ç›®ç‚ºäº¤é€šæˆ–ä½å®¿ï¼Œç„¡ç¨ç«‹æ™¯é»ä»‹ç´¹ã€‚'
    };


    // --- Vue App Setup ---
    createApp({
        setup() {
            // --- 1. Tab & Navigation State ---
            const currentTab = ref('day1');
            const dayMapNames = {
                'day1': 'ç¬¬ä¸€å¤© (12/6 é€±å…­)', 
                'day2': 'ç¬¬äºŒå¤© (12/7 é€±æ—¥)', 
                'day3': 'ç¬¬ä¸‰å¤© (12/8 é€±ä¸€)', 
                'day4': 'ç¬¬å››å¤© (12/9 é€±äºŒ)', 
                'day5': 'ç¬¬äº”å¤© (12/10 é€±ä¸‰)', 
                'flight': 'èˆªç­è³‡è¨Š',
                'accounting': 'è¨˜å¸³ç³»çµ±', 
                'packing': 'å¿…å¸¶ç‰©å“æ¸…å–®'
            };

            const dayName = computed(() => {
                return dayMapNames[currentTab.value] || 'è¡Œç¨‹';
            });
            
            const tabs = [
                { id: 'day1', name: '12/6', inactiveClass: 'bg-white text-blue-700 hover:bg-blue-100', activeClass: 'bg-blue-600 text-white' },
                { id: 'day2', name: '12/7', inactiveClass: 'bg-white text-blue-700 hover:bg-blue-100', activeClass: 'bg-blue-600 text-white' },
                { id: 'day3', name: '12/8', inactiveClass: 'bg-white text-blue-700 hover:bg-blue-100', activeClass: 'bg-blue-600 text-white' },
                { id: 'day4', name: '12/9', inactiveClass: 'bg-white text-blue-700 hover:bg-blue-100', activeClass: 'bg-blue-600 text-white' },
                { id: 'day5', name: '12/10', inactiveClass: 'bg-white text-blue-700 hover:bg-blue-100', activeClass: 'bg-blue-600 text-white' },
                { id: 'flight', name: 'âœˆï¸ èˆªç­', inactiveClass: 'bg-red-100 text-red-700 hover:bg-red-200', activeClass: 'bg-red-600 text-white' },
                { id: 'accounting', name: 'ğŸ’° è¨˜å¸³', inactiveClass: 'bg-yellow-100 text-green-700 hover:bg-yellow-200', activeClass: 'bg-green-600 text-white' },
                { id: 'packing', name: 'ğŸ’ æ¸…å–®', inactiveClass: 'bg-purple-100 text-purple-700 hover:bg-purple-200', activeClass: 'bg-purple-600 text-white' },
            ];

            // --- 2. Itinerary State & Logic (Updated with description/notes) ---
            const createItineraryItem = (time, activity) => ({
                id: Date.now() + Math.random(), 
                time, 
                activity, 
                editing: false,
                notes: '', // New field for user notes
                // æª¢æŸ¥æ˜¯å¦æœ‰é è¨­ä»‹ç´¹ï¼Œå¦å‰‡ä½¿ç”¨é€šç”¨æˆ–è‡ªå®šç¾©æ¨™ç±¤
                description: defaultDescriptions[activity] || 'ç„¡ç°¡çŸ­ä»‹ç´¹'
            });

            const itineraryData = ref({
                day1: [
                    createItineraryItem('10:00', 'æ¡ƒåœ’æ©Ÿå ´ âœˆï¸ æ—­å·æ©Ÿå ´ (åˆé¤æ©Ÿä¸Šæˆ–æ©Ÿå ´)'),
                    createItineraryItem('15:00', 'æ—­å·æ©Ÿå ´æ­è»Š/ç§Ÿè»Šå‰å¾€æ´çˆºæ¹–'),
                    createItineraryItem('18:30', 'å¤œå®¿ æ´çˆº æ¹–ç•”äº­ (æ™šé¤: æº«æ³‰æ—…é¤¨)'),
                    createItineraryItem('20:30', 'æ´çˆºæ¹–å†¬å­£å½©ç‡ˆç¯€ â„ï¸'),
                ],
                day2: [
                    createItineraryItem('09:00', 'æ´çˆºæ¹–å‡ºç™¼ï¼Œå‰å¾€å°æ¨½'),
                    createItineraryItem('11:30', 'å°æ¨½é‹æ²³ã€éŸ³æ¨‚ç›’å ‚ã€åŒ—ä¸€ç¡å­é¤¨'),
                    createItineraryItem('14:00', 'åˆé¤å¾Œï¼ŒAEON MALL (æœ­å¹Œå°æ¨½æ²¿ç·š) è³¼ç‰©/ä¼‘æ¯'),
                    createItineraryItem('18:00', 'å¤œå®¿ å®œå¿…æ€å°šå“æœ­å¹Œé…’åº—'),
                    createItineraryItem('20:00', 'æ™šé¤å¾Œï¼Œå¤œè¨ªè²å°è·¯ å•†åº—è¡— (è³¼ç‰©/å®µå¤œ)'),
                ],
                day3: [
                    createItineraryItem('09:00', 'æ™‚è¨ˆå°ã€åŒ—æµ·é“å»³èˆŠæœ¬å»³èˆ (è»Šç¶“/æ‹ç…§)'),
                    createItineraryItem('10:30', 'åŒ—æµ·é“ç¥å®® (åƒæ‹œ)'),
                    createItineraryItem('12:00', 'åˆé¤åŠå…ç¨…å•†åº— (æœ­å¹Œå¸‚å€)'),
                    createItineraryItem('14:30', 'é–‹è»Šå‰å¾€å°¼å…‹æ–¯æµ·æ´‹å…¬åœ’ (ç™»åˆ¥)'),
                    createItineraryItem('16:30', 'å°¼å…‹æ–¯æµ·æ´‹å…¬åœ’ ğŸ¬ (ä¼éµéŠè¡Œç­‰)'),
                    createItineraryItem('19:00', 'å¤œå®¿ æ£®ä¹‹åº­æ¸¡å‡æ‘ (æ™šé¤: æº«æ³‰æ¸¡å‡æ‘)'),
                ],
                day4: [
                    createItineraryItem('09:00', 'æ˜­å’Œæ–°å±±ã€ç†Šç‰§å ´ (èˆ‡æ£•ç†Šäº’å‹•)'),
                    createItineraryItem('11:00', 'é–‹è»Šå‰å¾€å‡½é¤¨'),
                    createItineraryItem('13:00', 'å¤§ã€å°æ²¼åœ‹ç«‹å…¬åœ’ (æ¹–ç•”æ™¯è§€)'),
                    createItineraryItem('16:00', 'é‡‘æ£®å€‰åº«ç¾¤ (æµ·ç£å€è³¼ç‰©)'),
                    createItineraryItem('18:00', 'å…¥ä½ æ¹¯å…ƒ å•„æœ¨äº­'),
                    createItineraryItem('20:00', 'å‡½é¤¨å±± ç™¾è¬å¤œæ™¯ ğŸŒƒ'),
                ],
                day5: [ 
                    createItineraryItem('08:00', 'å…ƒæ°£æœå¸‚ (æµ·é®®æœå¸‚ï¼Œäº«ç”¨æµ·é®®ä¸¼)'),
                    createItineraryItem('11:00', 'é€€æˆ¿ï¼Œå‰å¾€å‡½é¤¨æ©Ÿå ´'),
                    createItineraryItem('13:00', 'å‡½é¤¨æ©Ÿå ´ âœˆï¸ æ¡ƒåœ’æ©Ÿå ´ (è³¦æ­¸)'),
                ]
            });

            const currentItinerary = computed(() => {
                const current = itineraryData.value[currentTab.value] || [];
                // ä¾æ™‚é–“æ’åº
                return current.sort((a, b) => a.time.localeCompare(b.time));
            });

            const editItem = (item) => {
                // å„²å­˜åŸå§‹æ•¸æ“šä»¥ä¾›å–æ¶ˆç·¨è¼¯æ™‚ä½¿ç”¨
                item.originalTime = item.time;
                item.originalActivity = item.activity;
                item.editing = true;
            };

            const saveItem = (item) => {
                if (item.time.trim() && item.activity.trim()) {
                    item.editing = false;
                    delete item.originalTime;
                    delete item.originalActivity;
                    // æ›´æ–°æ™¯é»ä»‹ç´¹
                    item.description = defaultDescriptions[item.activity] || 'ç„¡ç°¡çŸ­ä»‹ç´¹';
                } else {
                    alert('æ™‚é–“å’Œåœ°é»/æ´»å‹•éƒ½ä¸èƒ½ç‚ºç©ºï¼');
                }
            };
            
            const cancelEdit = (item, index) => {
                if (item.id.toString().startsWith('new')) {
                    // å¦‚æœæ˜¯æ–°å¢ç‹€æ…‹ä¸‹å–æ¶ˆï¼Œå‰‡åˆªé™¤è©²é …ç›®
                    itineraryData.value[currentTab.value].splice(index, 1);
                } else {
                    // æ¢å¾©åˆ°ç·¨è¼¯å‰çš„ç‹€æ…‹
                    item.time = item.originalTime;
                    item.activity = item.originalActivity;
                    item.editing = false;
                    delete item.originalTime;
                    delete item.originalActivity;
                }
            };

            const deleteItem = (id) => {
                if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¡Œç¨‹é …ç›®å—ï¼Ÿ')) {
                    itineraryData.value[currentTab.value] = itineraryData.value[currentTab.value].filter(item => item.id !== id);
                }
            };

            const openAddItem = () => {
                // æª¢æŸ¥æ˜¯å¦å·²æœ‰æ­£åœ¨ç·¨è¼¯çš„æ–°é …ç›®
                if (currentItinerary.value.some(item => item.id.toString().startsWith('new'))) {
                    alert('è«‹å…ˆå„²å­˜æˆ–å–æ¶ˆç›®å‰æ­£åœ¨æ–°å¢çš„é …ç›®ã€‚');
                    return;
                }
                const newItem = createItineraryItem('', '');
                newItem.id = 'new' + Date.now();
                newItem.editing = true;
                itineraryData.value[currentTab.value].push(newItem);
            };
            
            // --- 2.1 Notes Modal Logic ---
            const showNotesModal = ref(false);
            const selectedItem = ref({}); // Current item being edited

            const openNotesModal = (item) => {
                selectedItem.value = item;
                showNotesModal.value = true;
            };

            const closeNotesModal = () => {
                showNotesModal.value = false;
            };
            

            // --- 3. Accounting System State & Logic ---
            const exchangeRateTWD = 0.2215; // JPY 1 = TWD 0.2215 (Hardcoded for single-file simplicity)
            const accountingData = ref([]);
            const newTransaction = reactive({
                description: '',
                amountJPY: null,
                category: ''
            });

            const sortedAccountingData = computed(() => {
                // ä¾ ID (æ™‚é–“æˆ³) é™å†ªæ’åˆ— (æœ€æ–°çš„åœ¨ä¸Šé¢)
                return accountingData.value.slice().sort((a, b) => b.id - a.id);
            });

            const totalJPY = computed(() => {
                return accountingData.value.reduce((sum, tx) => sum + tx.amountJPY, 0);
            });

            const totalTWD = computed(() => {
                return totalJPY.value * exchangeRateTWD;
            });

            const addTransaction = () => {
                if (!newTransaction.description || newTransaction.amountJPY <= 0 || !newTransaction.category) {
                    alert('è«‹å¡«å¯«å®Œæ•´çš„äº¤æ˜“è³‡è¨Š (æè¿°ã€é‡‘é¡å’Œé¡åˆ¥)ï¼');
                    return;
                }
                accountingData.value.push({
                    id: Date.now(),
                    description: newTransaction.description,
                    amountJPY: newTransaction.amountJPY,
                    amountTWD: newTransaction.amountJPY * exchangeRateTWD,
                    category: newTransaction.category,
                    date: new Date().toISOString()
                });

                // Reset form
                newTransaction.description = '';
                newTransaction.amountJPY = null;
                newTransaction.category = '';
            };

            const deleteTransaction = (id) => {
                if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç­†äº¤æ˜“ç´€éŒ„å—ï¼Ÿ')) {
                    accountingData.value = accountingData.value.filter(tx => tx.id !== id);
                }
            };

            const getCategoryColor = (category) => {
                const colorMap = {
                    'Food': 'bg-yellow-200 text-yellow-800',
                    'Shopping': 'bg-pink-200 text-pink-800',
                    'Transport': 'bg-indigo-200 text-indigo-800',
                    'Hotel': 'bg-teal-200 text-teal-800',
                    'Other': 'bg-gray-200 text-gray-800',
                };
                return colorMap[category] || 'bg-gray-200 text-gray-800';
            };
            
            const getCategoryEmoji = (category) => {
                const emojiMap = {
                    'Food': 'ğŸœ',
                    'Shopping': 'ğŸ›ï¸',
                    'Transport': 'ğŸšŒ',
                    'Hotel': 'ğŸ¨',
                    'Other': 'ğŸ’¡',
                };
                return emojiMap[category] || 'â“';
            };


            // --- 4. Packing List State & Logic ---
            const newCategory = ref('carryon'); // Default new item to carry-on
            const packingList = ref([
                // Carry-on items
                { id: 1, name: 'è­·ç…§ âœˆï¸', packed: false, category: 'carryon' },
                { id: 2, name: 'æ—¥å¹£ç¾é‡‘ ğŸ’´', packed: false, category: 'carryon' },
                { id: 3, name: 'æ‰‹æ©Ÿ/å……é›»å¯¶ ğŸ”‹', packed: false, category: 'carryon' },
                { id: 4, name: 'åšå¤–å¥— (ä¸Šæ©Ÿç©¿è‘—) ğŸ§¥', packed: false, category: 'carryon' },
                // Checked items
                { id: 5, name: 'é˜²æ°´é›ªé´ ğŸ‘¢', packed: false, category: 'checked' },
                { id: 6, name: 'æ¯›è¡£/ä¿æš–å…§è¡£ (5å¥—)', packed: false, category: 'checked' },
                { id: 7, name: 'ä¿æš–æ‰‹å¥—/åœå·¾/å¸½å­ ğŸ§¤', packed: false, category: 'checked' },
                { id: 8, name: 'è½‰æ›æ’é ­/å»¶é•·ç·š ğŸ”Œ', packed: false, category: 'checked' },
                { id: 9, name: 'å¸¸ç”¨è—¥å“/OKç¹ƒ ğŸ’Š', packed: false, category: 'checked' },
                
            ]);
            const newItemName = ref('');

            const filteredPackingList = (category) => {
                return packingList.value.filter(item => item.category === category);
            };

            const packedCount = computed(() => {
                return packingList.value.filter(item => item.packed).length;
            });
            
            const carryonCount = computed(() => {
                return filteredPackingList('carryon').length;
            });
            
            const checkedCount = computed(() => {
                return filteredPackingList('checked').length;
            });


            const addPackingItem = () => {
                if (newItemName.value.trim()) {
                    packingList.value.push({
                        id: Date.now(),
                        name: newItemName.value.trim(),
                        packed: false,
                        category: newCategory.value // Add the selected category
                    });
                    newItemName.value = '';
                }
            };

            const togglePackingItem = (id) => {
                const item = packingList.value.find(item => item.id === id);
                if (item) {
                    item.packed = !item.packed;
                }
            };

            const deletePackingItem = (id) => {
                if (confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç‰©å“å—ï¼Ÿ')) {
                    packingList.value = packingList.value.filter(item => item.id !== id);
                }
            };
            
            const resetPackingList = () => {
                if(confirm('ç¢ºå®šè¦å°‡æ‰€æœ‰ç‰©å“çš„æ‰“åŒ…ç‹€æ…‹é‡è¨­ç‚ºæœªæ‰“åŒ…å—ï¼Ÿ')){
                    packingList.value.forEach(item => {
                        item.packed = false;
                    });
                }
            };


            // --- 5. Weather State & Logic ---
            const weatherData = ref({});
            const showWeatherDetail = ref(false);

            const fetchWeather = async () => {
                for (const day in weatherLocations) {
                    const { lat, lon, location, desc } = weatherLocations[day];
                    try {
                        // ä½¿ç”¨ Open-Meteo API ç²å–ç•¶å‰å¤©æ°£
                        const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&timezone=Asia%2FTokyo`);
                        const data = await response.json();
                        const temp = Math.round(data.current_weather.temperature);
                        const code = data.current_weather.weathercode;
                        
                        weatherData.value[day] = {
                            location: location,
                            temp: temp,
                            icon: getWeatherIcon(code),
                            desc: desc
                        };
                    } catch (error) {
                        console.error(`Error fetching weather for ${location}`, error);
                        weatherData.value[day] = { location, temp: 'N/A', icon: 'â“', desc: 'ç„¡æ³•å–å¾—æ•¸æ“š' };
                    }
                }
            };

            const weatherDisplay = computed(() => {
                // åªæœ‰åœ¨è¡Œç¨‹é ç±¤æ‰é¡¯ç¤ºè©²æ—¥æœŸçš„å¤©æ°£
                if (currentTab.value.startsWith('day')) {
                    return weatherData.value[currentTab.value];
                }
                return null;
            });

            const toggleWeatherDetail = () => {
                showWeatherDetail.value = !showWeatherDetail.value;
            };

            // --- 6. Persistence (LocalStorage) ---
            const saveToLocalStorage = () => {
                const data = {
                    itinerary: itineraryData.value,
                    accounting: accountingData.value,
                    packing: packingList.value,
                    version: '5-day-trip-v3' 
                };
                localStorage.setItem(APP_KEY, JSON.stringify(data));
            };

            const loadFromLocalStorage = () => {
                const saved = localStorage.getItem(APP_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    
                    // æª¢æŸ¥ç‰ˆæœ¬ï¼Œç¢ºä¿è¡Œç¨‹å’Œæ¸…å–®çµæ§‹çš„é‡å¤§æ›´æ–°èƒ½æ­£ç¢ºè¼‰å…¥
                    if (data.version === '5-day-trip-v3') {
                        itineraryData.value = data.itinerary || itineraryData.value;
                        packingList.value = data.packing || packingList.value;
                    } else {
                         // å¦‚æœæ˜¯èˆŠç‰ˆæœ¬ï¼Œè¼‰å…¥èˆŠè¡Œç¨‹ä¸¦æ‰‹å‹•è£œä¸Š description/notes å­—æ®µ
                         const loadedItinerary = data.itinerary || itineraryData.value;
                         for (const day in loadedItinerary) {
                             loadedItinerary[day].forEach(item => {
                                 // è£œä¸Š notes å’Œ description å­—æ®µ
                                 if (typeof item.notes === 'undefined') {
                                     item.notes = '';
                                 }
                                 if (typeof item.description === 'undefined' || item.description === 'ç„¡ç°¡çŸ­ä»‹ç´¹') {
                                     item.description = defaultDescriptions[item.activity] || 'ç„¡ç°¡çŸ­ä»‹ç´¹';
                                 }
                             });
                         }
                         itineraryData.value = loadedItinerary;
                         packingList.value = data.packing || packingList.value;
                    }

                    accountingData.value = data.accounting || [];
                }
            };
            
            // Watchers to auto-save data
            watch(itineraryData, saveToLocalStorage, { deep: true });
            watch(accountingData, saveToLocalStorage, { deep: true });
            watch(packingList, saveToLocalStorage, { deep: true }); 

            // --- Lifecycle Hooks ---
            onMounted(() => {
                loadFromLocalStorage();
                fetchWeather();
            });

            return {
                currentTab,
                dayName,
                tabs,
                // Itinerary
                itineraryData,
                currentItinerary,
                editItem,
                saveItem,
                cancelEdit,
                deleteItem,
                openAddItem,
                // Links
                generateGoogleMapsUrl,
                openLink,
                // Notes Modal
                showNotesModal,
                selectedItem,
                openNotesModal,
                closeNotesModal,
                // Accounting
                exchangeRateTWD,
                accountingData,
                newTransaction,
                totalJPY,
                totalTWD,
                sortedAccountingData,
                addTransaction,
                deleteTransaction,
                getCategoryColor,
                getCategoryEmoji,
                // Packing List
                packingList,
                newItemName,
                newCategory,
                packedCount,
                carryonCount,
                checkedCount,
                filteredPackingList,
                addPackingItem,
                togglePackingItem,
                deletePackingItem,
                resetPackingList,
                // Weather
                weatherDisplay,
                showWeatherDetail,
                toggleWeatherDetail
            };
        }
    }).mount('#app');
</script>

</body>
</html>
